<!DOCTYPE html>
<html>
<head>
  <title>AR Video Tracking</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar-js@1.2.5/dist/mindar-image-three.prod.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #ar-container {
      width: 100vw;
      height: 100vh;
    }
    #toggle-button {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      padding: 10px;
      font-size: 16px;
    }
    #video-player {
      display: none;
    }
  </style>
</head>
<body>
  <button id="toggle-button">Start Camera</button>
  <div id="ar-container"></div>
  <video id="video-player" src="your-video.mp4" loop></video>
  <script>
    const toggleButton = document.getElementById("toggle-button");
    const videoPlayer = document.getElementById("video-player");
    const arContainer = document.getElementById("ar-container");

    let mindarThree = null;
    let started = false;
    let hiddenCameraElements = [];

    // Check if camera access is available
    async function checkCameraAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop()); // Stop the stream after checking
        console.log("Camera access granted");
        return true;
      } catch (err) {
        console.error("Camera access denied or unavailable:", err);
        alert("Camera access is required. Please allow camera permissions and ensure you're using HTTPS or localhost.");
        return false;
      }
    }

    toggleButton.addEventListener("click", async () => {
      if (!started) {
        // Verify camera access before starting
        const hasCameraAccess = await checkCameraAccess();
        if (!hasCameraAccess) return;

        toggleButton.textContent = "Stop Camera";
        console.log("Initializing MindAR...");

        try {
          // Initialize MindAR
          mindarThree = new window.MINDAR.IMAGE.MindARThree({
            container: arContainer,
            imageTargetSrc: "targets.mind"
          });

          const { renderer, scene, camera } = mindarThree;
          const anchor = mindarThree.addAnchor(0);

          // Log when MindAR is set up
          console.log("MindAR initialized, starting camera...");

          // Create a video texture
          const videoTexture = new THREE.VideoTexture(videoPlayer);
          videoTexture.minFilter = THREE.LinearFilter;
          videoTexture.magFilter = THREE.LinearFilter;

          // Create a material with the video texture
          const videoMaterial = new THREE.MeshBasicMaterial({
            map: videoTexture,
            side: THREE.DoubleSide
          });

          // Create a plane geometry for the video
          const videoGeometry = new THREE.PlaneGeometry(1, 0.5625);
          const videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);

          // Add a simple frame
          const frameGeometry = new THREE.BoxGeometry(1.1, 0.6625, 0.05);
          const frameMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
          const frameMesh = new THREE.Mesh(frameGeometry, frameMaterial);
          frameMesh.position.set(0, 0, -0.01);

          // Add video and frame to the anchor
          anchor.group.add(videoMesh);
          anchor.group.add(frameMesh);

          anchor.onTargetFound = () => {
            console.log("Marker detected, playing video...");
            videoPlayer.play();

            // Optionally hide the camera feed
            hiddenCameraElements = arContainer.querySelectorAll("canvas, video");
            hiddenCameraElements.forEach(el => {
              el.style.display = "none";
            });
          };

          anchor.onTargetLost = () => {
            console.log("Marker lost, pausing video...");
            videoPlayer.pause();

            // Show the camera feed
            hiddenCameraElements.forEach(el => {
              el.style.display = "block";
            });
          };

          // Start MindAR
          await mindarThree.start();
          console.log("MindAR started successfully");
          started = true;

          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });
        } catch (err) {
          console.error("Error starting MindAR:", err);
          alert("Failed to start AR. Check console for details and ensure targets.mind is correct.");
          toggleButton.textContent = "Start Camera";
        }
      } else {
        toggleButton.textContent = "Start Camera";
        console.log("Stopping MindAR...");

        videoPlayer.pause();

        if (hiddenCameraElements.length > 0) {
          hiddenCameraElements.forEach(el => {
            el.style.display = "block";
          });
        }

        try {
          await mindarThree.stop();
          console.log("MindAR stopped successfully");
        } catch (err) {
          console.error("Error stopping MindAR:", err);
        }

        mindarThree = null;
        started = false;
      }
    });
  </script>
</body>
</html>
